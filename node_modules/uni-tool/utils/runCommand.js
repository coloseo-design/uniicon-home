const isWindows = require('is-windows');
const { spawn } = require('child_process');
const getRunCmdEnv = require('./getEnv');

/**
 *
 * @param {* string} cmd 执行的命令
 * @param {* array} _args 参数
 * @param {* Function} fn 命令执行完成的回调函数
 */
function runCmd(cmd, _args, fn) {
  const args = _args || [];
  // windows只能在bat和cmd中执行, 第一个参数为执行程序
  // windows命令行参数数组第一参数为/c
  // windows执行命令大致为 ['cmd.exe', ['/c', 'your command']]
  if (isWindows()) {
    args.unshift(cmd);
    args.unshift('/c');
    // eslint-disable-next-line no-param-reassign
    cmd = process.env.ComSpec || 'cmd.exe';
  }
  const runner = spawn(cmd, args, {
    // keep color
    stdio: 'inherit',
    env: getRunCmdEnv(),
  });

  runner.on('message', (...message) => {
    process.stdout.write('message', ...message);
  });
  runner.on('error', (e) => {
    process.stdout.write('e', e);
  });
  runner.on('close', (code) => {
    if (fn) {
      fn(code);
    }
  });
}

module.exports = runCmd;
